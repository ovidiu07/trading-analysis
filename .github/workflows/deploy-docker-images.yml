name: Docker compose up

on:
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Copy Docker Compose file to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ vars.TRADER_SERVER_HOST }}
          username: ${{ vars.TRADER_SERVER_USERNAME }}
          key: ${{ secrets.TRADER_SSH_PRIVATE_KEY }}
          source: src/main/resources/compose.yml
          target: ~/docker-compose

      - name: Deploy to server
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ vars.TRADER_SERVER_HOST }}
          username: ${{ vars.TRADER_SERVER_USERNAME }}
          key: ${{ secrets.TRADER_SSH_PRIVATE_KEY }}
          script: |
            set -e
            cd ~/docker-compose/src/main/resources

            # Write runtime secrets/config for docker compose (do not commit this file)
            cat > .env <<EOF
            DB_URL=${{ secrets.DB_URL }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASS=${{ secrets.DB_PASS }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            FRONTEND_URL=${{ secrets.FRONTEND_URL }}
            EOF

            docker-compose -f compose.yml pull
            docker-compose -f compose.yml up -d

      - name: Final message
        run: echo Finished!
